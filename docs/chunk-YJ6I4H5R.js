import{a as Be}from"./chunk-NO5ZLMGJ.js";import{a as Ve}from"./chunk-RSTW56Y6.js";import{b as Pe}from"./chunk-EETWG5P3.js";import{a as $e}from"./chunk-6JCGAI3C.js";import{a as Ie,b as ve,c as De,f as Me,g as Ee}from"./chunk-2XMF3NCH.js";import{b as Ne,c as ye,f as ke,i as we,j as Fe,k as Oe,r as Re}from"./chunk-I2SFVS3Z.js";import{b as Te}from"./chunk-YOSYX5R3.js";import{a as xe}from"./chunk-RA4HR7YG.js";import{a as F}from"./chunk-Y3YQYZ4W.js";import{B as fe,D as ge,F as _e,G as he,I as Ce,K as Se,a as H,b as J,g as ne,l as re,n as ae,o as se,r as le,s as me,v as de,w as ce,x as pe,z as ue}from"./chunk-LN33XJJG.js";import{a as be}from"./chunk-2KDJOZPQ.js";import{$ as ee,M as Q,O as K,P as X,T as w,V as W,W as Y,X as Z,Z as E,ca as te,da as ie,ma as oe}from"./chunk-6K6YQ32S.js";import{D as z,e as q,l as G,r as T}from"./chunk-DDJAZSWD.js";import{b as Ae}from"./chunk-WRDENF74.js";import{Ab as _,Cb as y,Db as k,Eb as C,Fb as n,Gb as r,Hb as M,Mb as I,Qb as S,S as D,Sb as d,Wa as a,Wb as $,Xb as B,Y as R,Yb as j,ab as V,ba as x,ec as l,f as A,ga as p,gb as P,gc as c,ha as u,oc as U,u as O,xc as L,zb as g}from"./chunk-D6M5U3FV.js";import{a as h,b}from"./chunk-MGTJOKXF.js";var je=(m=>(m.INITIAL="initial",m.ANNOTATED="annotated",m.ALL="all",m.TREATED="treated",m.TO_PROCESS="to-process",m))(je||{});var Ue=(s=>(s.TO_ADMIN_ASSISTANT="aa",s.TO_SENIOR_ASSISTANT="sa",s.TO_DIRECTOR="dir",s.TO_BE_PROCESSED="proc",s))(Ue||{});var He=["fileInput"],Je=o=>({"bg-gray-100 border-blue-500":o}),Le=(o,e)=>e.id;function Qe(o,e){if(o&1&&(n(0,"mat-option",22),l(1),r()),o&2){let t=e.$implicit;C("value",t.id),a(),c(" ",t.full_name," ")}}function Ke(o,e){if(o&1&&(n(0,"mat-error"),l(1),r()),o&2){let t=d(3);a(),c(" ",t.getErrorSeriorAssistant(t.assigneeFormControlName)," ")}}function Xe(o,e){if(o&1&&(n(0,"mat-form-field",15)(1,"mat-label"),l(2,"Assistant principal charg\xE9 de la validation"),r(),n(3,"mat-select",21),y(4,Qe,2,2,"mat-option",22,Le),r(),g(6,Ke,2,1,"mat-error"),r()),o&2){let t,i=d(2);a(3),C("formControlName",i.assigneeFormControlName),a(),k(i.seniorAssistants),a(2),_((t=i.form.get(i.assigneeFormControlName))!=null&&t.hasError("required")?6:-1)}}function We(o,e){if(o&1&&(n(0,"mat-option",22),l(1),r()),o&2){let t=e.$implicit;C("value",t.id),a(),c(" ",t.full_name," ")}}function Ye(o,e){if(o&1&&(n(0,"mat-error"),l(1),r()),o&2){let t=d(3);a(),c(" ",t.getErrorSeriorAssistant(t.assigneeFormControlName)," ")}}function Ze(o,e){if(o&1&&(n(0,"mat-form-field",15)(1,"mat-label"),l(2,"Directeur charg\xE9 de traitement de ce courrier"),r(),n(3,"mat-select",21),y(4,We,2,2,"mat-option",22,Le),r(),g(6,Ye,2,1,"mat-error"),r()),o&2){let t,i=d(2);a(3),C("formControlName",i.assigneeFormControlName),a(),k(i.directors),a(2),_((t=i.form.get(i.assigneeFormControlName))!=null&&t.hasError("required")?6:-1)}}function et(o,e){if(o&1&&(n(0,"mat-error"),l(1),r()),o&2){let t=d(2);a(),c(" ",t.getErrorComment(t.commentFormControlName)," ")}}function tt(o,e){if(o&1){let t=I();n(0,"mat-checkbox",23),S("change",function(s){p(t);let m=d(2);return u(m.onCheckboxChange(s))}),l(1,"Joindre un fichier scann\xE9"),r()}}function it(o,e){if(o&1&&(n(0,"p",28),l(1),r()),o&2){let t=d(3);a(),c("Fichier : ",t.pdfService.localPdf.name," ")}}function ot(o,e){if(o&1&&(n(0,"mat-error",29),l(1),r()),o&2){let t=d(3);a(),c(" ",t.errorMessage," ")}}function nt(o,e){if(o&1){let t=I();n(0,"div",20)(1,"div",24),S("click",function(){p(t);let s=d(2);return u(s.triggerFileInput())})("dragover",function(s){p(t);let m=d(2);return u(m.onDragOver(s))})("dragleave",function(s){p(t);let m=d(2);return u(m.onDragLeave(s))})("drop",function(s){p(t);let m=d(2);return u(m.onDrop(s))}),n(2,"mat-icon",25),l(3,"attach_file"),r(),n(4,"p",26),l(5," D\xE9posez ici un fichier au format PDF ou image, ou "),n(6,"span",27),l(7," cliquez "),r(),l(8," pour le s\xE9lectionner."),r(),g(9,it,2,1,"p",28),r(),g(10,ot,2,1,"mat-error",29),r()}if(o&2){let t=d(2);a(),C("ngClass",U(3,Je,t.isDragging)),a(8),_(t.pdfService.localPdf?9:-1),a(),_(t.errorMessage!==""?10:-1)}}function rt(o,e){if(o&1){let t=I();n(0,"form",11),S("ngSubmit",function(){p(t);let s=d();return u(s.onSubmit())}),n(1,"div",12)(2,"h1",13),l(3),r(),n(4,"p"),l(5),r()(),n(6,"div",14),g(7,Xe,7,2,"mat-form-field",15)(8,Ze,7,2,"mat-form-field",15),n(9,"div",16)(10,"mat-checkbox",17),l(11," Transf\xE9rer directement "),n(12,"span"),l(13),r()()()(),n(14,"div",12)(15,"h1",13),l(16),r(),n(17,"p"),l(18),r()(),M(19,"editor",18),g(20,et,2,1,"mat-error"),g(21,tt,2,0,"mat-checkbox",19),g(22,nt,11,5,"div",20),r()}if(o&2){let t,i=d();C("formGroup",i.form),a(3),c("",i.role===i.roles.ADMIN_ASSISTANT?"Validateur (Assistant Principal)":"Directeur"," "),a(2),c(" Cette personne ",i.role===i.roles.ADMIN_ASSISTANT?"est charg\xE9e de valider l'annoation et de transf\xE9rer le courrier au directeur concern\xE9":"est charg\xE9e du traitement de ce courrier",". "),a(2),_(i.role===i.roles.ADMIN_ASSISTANT?7:8),a(6),c(" ",i.role===i.roles.ADMIN_ASSISTANT?"\xE0 l'assistant principal pour validation":"au directeur pour traitement"," "),a(3),c("Ajouter une annotation (visible par ",i.role===i.roles.ADMIN_ASSISTANT?"le personnel de direction":"la personne charg\xE9e du traitement",") "),a(2),c(" Votre annotation sera visible par ",i.role===i.roles.ADMIN_ASSISTANT?"l'Assistant Principal charg\xE9 de validation":"le Directeur charg\xE9 du traitement"," "),a(),C("formControlName",i.commentFormControlName)("init",i.init),a(),_((t=i.form.get(i.commentFormControlName))!=null&&t.hasError("required")&&i.form.touched?20:-1),a(),_(i.data.mail.scanned_document===null?21:-1),a(),_(i.disabled?22:-1)}}function at(o,e){o&1&&(n(0,"div",5),M(1,"mat-spinner"),r())}var N=class o{dialogRef=x(ve);message=x(xe);data=x(De);http=x(be);stateService=x(Ae);pdfService=x($e);disabled=!1;errorMessage="";isDragging=!1;isExternalMail=!1;init={plugins:"lists link image table code help wordcount",height:350};fileInput;form;unsubscribeSA$=new A;unsubscribeDir$=new A;unsubscribeMail$=new A;unsubscribeAa$=new A;seniorAssistants=[];directors=[];uploadProgress=0;xSmallOrSmall=L(()=>this.stateService.XSmallOrSmall());mail;roles=F;role=this.http.role;commentFormControlName;assigneeFormControlName;isFormReady=!1;ngOnInit(){this.loadData()}ngOnDestroy(){this.unsubscribeSA$.next(),this.unsubscribeSA$.complete(),this.unsubscribeDir$.next(),this.unsubscribeDir$.complete(),this.unsubscribeAa$.next(),this.unsubscribeAa$.complete()}initForm(){this.commentFormControlName=this.role==="ADMIN_ASSISTANT"?"admin_assistant_comment":"senior_assistant_comment",this.assigneeFormControlName=this.role==="ADMIN_ASSISTANT"?"senior_assistant_id":"director_id";let e="";e=this.data.mail.seniorAssistant?this.data.mail.seniorAssistant.id:"";let t={should_send_document:new E(!1),[this.commentFormControlName]:new E(this.data.mail[this.commentFormControlName],[w.required]),[this.assigneeFormControlName]:new E(3,[w.required])};this.form=new Z(t)}getErrorComment(e){return this.form.get(e).hasError("required")?"Ce champ est requis":this.form.get(e).hasError("minlength")?"L'annotation doit contenir au moins 10 caract\xE8res.":""}getErrorSeriorAssistant(e){return this.form.get(e).hasError("required")?"Ce champ est requis":""}onClose(){this.dialogRef.close()}triggerFileInput(){this.fileInput.nativeElement.value="",this.fileInput.nativeElement.click()}onDragOver(e){e.preventDefault(),this.isDragging=!0}onDragLeave(e){e.preventDefault(),this.isDragging=!1}onDrop(e){e.preventDefault(),this.isDragging=!1;let t=e.dataTransfer?.files;t&&this.handleFile(t[0])}onFileSelected(e){let i=e.target.files;i&&this.handleFile(i[0])}handleFile(e){this.pdfService.handleFile(e)}onSubmit(){if(this.form.invalid){this.form.markAllAsTouched(),this.message.openSnackBar("Veuillez corriger les erreurs du formulaire.","Fermer",4e3);return}this.update()}update(){this.http.url=`${this.data.endpoint}/${this.data.mail.id}`,this.http.sendFormData(JSON.stringify(this.form.value),this.pdfService.localPdf,"patch").subscribe({next:e=>{e.type===T.UploadProgress?this.uploadProgress=Math.round(e.loaded/(e.total||1)*100):e.type===T.Response&&(this.message.openSnackBar("Commentaire ajout\xE9 avec succ\xE8s !","Fermer",4e3),this.dialogRef.close(e.body))},error:e=>{this.message.openSnackBar("Une erreur est survenue, veuillez r\xE9essayer.","Fermer",4e3),this.uploadProgress=0},complete:()=>{}})}onCheckboxChange(e){this.disabled=e.checked}loadData(){let e={mail:this.getMail()};this.role==="ADMIN_ASSISTANT"?e.senior_assistants=this.getSeniorAssistant():this.role==="SENIOR_ASSISTANT"&&(e.directors=this.getDirectors()),O(e).subscribe({next:t=>{this.data.mail=t.mail,this.role==="ADMIN_ASSISTANT"?this.seniorAssistants=t.senior_assistants:this.role==="SENIOR_ASSISTANT"&&(this.directors=t.directors),this.initForm(),this.isFormReady=!0},error:t=>{this.message.openSnackBar("Une erreur est survenue lors du chargement des donn\xE9es. Veuillez r\xE9essayer.","Fermer",800)}})}getDirectors(){return this.http.url="users/by-role/DIRECTOR",this.http.get().pipe(D(this.unsubscribeDir$))}getSeniorAssistant(){return this.http.url="users/by-role/SENIOR_ASSISTANT",this.http.get().pipe(D(this.unsubscribeSA$))}getMail(){return this.http.url=`${this.data.endpoint}/${this.data.mail.id}`,this.http.get().pipe(D(this.unsubscribeMail$))}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=P({type:o,selectors:[["app-comment-dialog-component"]],viewQuery:function(t,i){if(t&1&&$(He,5),t&2){let s;B(s=j())&&(i.fileInput=s.first)}},decls:18,vars:2,consts:[["fileInput",""],[1,"flex","items-center","justify-between","px-4","py-2","bg-white","dark:bg-gray-900","shadow-sm"],[1,"text-lg","font-semibold","text-gray-800","dark:text-gray-300"],["mat-icon-button","",3,"click"],[1,"-mx-3","md:-mx-0",3,"formGroup"],[1,"flex","items-center","justify-center","my-10"],[1,"mt-2"],[1,"border-gray-300"],["mat-flat-button","","cdkFocusInitial","",3,"click"],["matButton","elevated","cdkFocusInitial","",3,"click"],["type","file","accept",".jpg, .jpeg, .png, application/pdf",1,"hidden",3,"change"],[1,"-mx-3","md:-mx-0",3,"ngSubmit","formGroup"],[1,"w-full","mb-4"],[1,"text-lg","font-bold"],[1,"w-full"],["appearance","outline",1,"w-full"],[1,"w-full","flex","justify-end"],["formControlName","should_send_document",1,"-mt-5"],["apiKey","3dejrpuyh0ucy7n25448c4t5p79rrkaiwdfxfxfdcmrum9if","licenseKey","gpl",1,"w-full",3,"formControlName","init"],["labelPosition","after"],[1,"w-full","mt-1"],["matInput","",3,"formControlName"],[3,"value"],["labelPosition","after",3,"change"],[1,"p-1","w-full","h-56","flex","flex-col","items-center","justify-center","border-2","border-dashed","border-gray-400","bg-white","rounded-lg","cursor-pointer","hover:border-blue-500","transition",3,"click","dragover","dragleave","drop","ngClass"],[1,"mat-18"],[1,"text-gray-600","text-lg","text-center","mt-2","px-1"],[1,"text-blue-500","font-bold"],[1,"text-lg","border-t-4","border-r-gray-100","mt-0.5"],[1,"mt-1.5"]],template:function(t,i){if(t&1){let s=I();n(0,"div",1)(1,"h2",2),l(2),r(),n(3,"button",3),S("click",function(){return p(s),u(i.onClose())}),n(4,"mat-icon"),l(5,"close"),r()()(),n(6,"mat-dialog-content"),g(7,rt,23,12,"form",4)(8,at,2,0,"div",5),r(),n(9,"div",6),M(10,"hr",7),r(),n(11,"mat-dialog-actions")(12,"button",8),S("click",function(){return p(s),u(i.onSubmit())}),l(13," Sauvegarder "),r(),n(14,"button",9),S("click",function(){return p(s),u(i.onClose())}),l(15," Fermer "),r()(),n(16,"input",10,0),S("change",function(f){return p(s),u(i.onFileSelected(f))}),r()}t&2&&(a(2),c(" ",i.data.title," "),a(5),_(i.isFormReady?7:8))},dependencies:[Ne,ye,ke,we,Oe,Fe,me,le,ae,se,re,Te,Re,G,q,J,H,X,K,Q,z,oe,ee,W,Y,te,ie,ne,de,pe,ce,ue,fe,he,_e,ge,Ce,Se,Me,Ee,Pe],styles:[".mat-mdc-dialog-container .mdc-dialog__surface{border-radius:0!important}"]})};var qe=class o extends Be{constructor(e,t,i){super(e,t,i)}openAddCommentDialog(e,t){let i=new Ie;i.disableClose=!0,i.data={title:`ANNOTATION ASSISTANT${this.http.role==="ADMIN_ASSISTANT"?" ADMINISTRATIF":" PRINCIPAL"}`,mail:e,endpoint:this.endpoint},i.minWidth=this.xSmallOrSmall()?"96vw":"57vw",this.dialog.open(N,i).afterClosed().subscribe(m=>{if(m&&t==="initial")this.buildInitial();else if(m){let f=this.page.items.findIndex(v=>v.id===m.id);f!==-1&&(this.page.items[f].status=m.status)}})}buildInitial(){let e=h({},this.criteria);switch(this.http.role){case"MAIL_ARCHIVES_AGENT":case"EXECUTIVE_SECRETARY":this.search(e);break;case"ADMIN_ASSISTANT":case"SENIOR_ASSISTANT":this.search(b(h({},e),{withAnnotated:!1}));break;case"DIRECTOR":this.search(b(h({},e),{processed:!1}));break;default:this.search(e)}}buildToProcess(){this.search(b(h({},this.criteria),{assigned_to_me:!0}))}buildAnnotated(){(this.http.role==="ADMIN_ASSISTANT"||this.http.role==="SENIOR_ASSISTANT")&&this.search(b(h({},this.criteria),{withAnnotated:!0}))}buildAll(){let e=h({},this.criteria);switch(this.http.role){case"ADMIN_ASSISTANT":case"SENIOR_ASSISTANT":this.search(e);break;case"DIRECTOR":this.search(b(h({},e),{processed:void 0}));break;default:this.search(e)}}buildTreated(){this.search(b(h({},this.criteria),{processed:!0}))}send(e){this.uploadProgress=0;let t=this.http.role,i=t==="ADMIN_ASSISTANT"?"\xE0 l'Assistant Principal pour validation":"au Directeur pour traitement";this.dialog.open(Ve,{data:{message:`Souhaitez-vous vraiment envoyer ce courrier ${i} ?`,buttonText:{ok:"Oui",cancel:"Non"}}}).afterClosed().subscribe(m=>{m&&(this.http.url=`${this.endpoint}/${e.id}`,this.http.sendFormData(JSON.stringify({should_send_document:!0}),null,"patch").subscribe({next:f=>{if(f.type===T.UploadProgress)this.uploadProgress=Math.round(f.loaded/(f.total||1)*100);else if(f.type===T.Response){let v=this.page.items.findIndex(Ge=>Ge.id===f.body.id);v!==-1&&(this.page.items[v].status=t==="ADMIN_ASSISTANT"?"sa":"dir")}},error:()=>{this.message.openSnackBar("Une erreur est survenue, veuillez r\xE9essayer.","Fermer",4e3)},complete:()=>{this.message.openSnackBar("Op\xE9ration effectu\xE9e avec succ\xE8s !","Fermer",4e3)}}))})}selectTab(e,t=!1){switch(t&&(this.criteria.page=1,this.criteria.pageSize=6,this.pageIndex=0),e){case"initial":this.buildInitial();break;case"annotated":this.buildAnnotated();break;case"all":this.buildAll();break;case"treated":this.buildTreated();break;case"to-process":this.buildToProcess();break;default:}this.tab=e,sessionStorage.setItem(this.key,e)}actionButton(e){switch(e){case"goToForm":this.goToForm("add");break;case"refresh":this.buildInitial();break;case"print":break;default:}}menuSelected(e){switch(e.action){case"view_detail":this.gotToDetails(e.data);break;case"add_comment":this.openAddCommentDialog(e.data,this.tab);break;case"receipt":this.receiptPrintService.print(e.data);break;case"display_mail":this.displayOnline(e.data.id,"document");break;case"download_mail":this.downloadDocument(e.data.id,"document");break;case"share_mail":break;case"treatment_proof":this.addFile(e.data,"Ajouter un justificatif de traitement","treatment-proof");break;case"display_proof":this.displayOnline(e.data.id,"proof");break;case"download_proof":this.downloadDocument(e.data.id,"proof");break;case"share_proof":break;case"assign_agent":break;case"edit_mail":this.goToForm(e.action,e.data);break;case"delete_mail":break;case"send":this.send(e.data);break;default:console.warn("Action non g\xE9r\xE9e :")}}static \u0275fac=function(t){V()};static \u0275prov=R({token:o,factory:o.\u0275fac,providedIn:"root"})};export{je as a,Ue as b,qe as c};
